---
title: Make model diagrams, Kruschke style
author: ''
date: '2020-03-09'
slug: make-model-diagrams-kruschke-style
categories: []
tags:
  - Bayesian
  - Kruschke
  - plot
  - R
  - tidyverse
  - tutorial
authors: []
header:
  caption: ''
  image: ''
  preview: yes
---



<div id="tldr" class="section level2">
<h2>tl;dr</h2>
<p>You too can make model diagrams with the <strong>tidyverse</strong> and <strong>patchwork</strong> packages. Here’s how.</p>
</div>
<div id="diagrams-can-help-us-understand-statistical-models." class="section level2">
<h2>Diagrams can help us understand statistical models.</h2>
<p>I’ve been working through John Kruschke’s <a href="https://sites.google.com/site/doingbayesiandataanalysis/"><em>Doing Bayesian data analysis, Second Edition: A tutorial with R, JAGS, and Stan</em></a> and translating it into <strong>brms</strong> and <strong>tidyverse</strong>-style workflow. At this point, the bulk of the work is done and you can check it out at <a href="https://bookdown.org/content/3686/">https://bookdown.org/content/3686/</a>. One of Kruschke’s unique contributions was the way he used diagrams to depict his statistical models. Here’s an example from the text (Figure 8.2 on page 196):</p>
<p><img src="/img/Kruschke_figure8.2.png" /></p>
<p>In the figure’s caption, we read:</p>
<blockquote>
<p>Diagram of model with Bernoulli likelihood and beta prior. The pictures of the distributions are intended as stereotypical icons, and are not meant to indicate the exact forms of the distributions. Diagrams like this should be scanned from the bottom up, starting with the data <span class="math inline">\(y_i\)</span> and working upward through the likelihood function and prior distribution. Every arrow in the diagram has a corresponding line of code in a JAGS model specification.</p>
</blockquote>
<p>Making diagrams like this is a bit of a challenge because even Kruchke, who is no <strong>R</strong> slouch, used other software to make his diagrams. In the comments section from his blog post, <a href="http://doingbayesiandataanalysis.blogspot.com/2012/05/graphical-model-diagrams-in-doing.html"><em>Graphical model diagrams in Doing Bayesian Data Analysis versus traditional convention</em></a>, Kruschke remarked he made these “‘by hand’ in OpenOffice.” If you look over to the <a href="https://tex.stackexchange.com/questions/55869/how-to-produce-john-kruschkes-bayesian-model-diagrams-using-tikz-or-similar-too"><em>How to produce John Kruschke’s Bayesian model diagrams using TikZ or similar tools?</em></a> thread in StackExchange, you’ll find a workflow to make plots like this with TikZ. In a related <a href="https://github.com/rasmusab/distribution_diagrams/blob/master/readme.md">GitHub repo</a>, the great Rasmus Bååth showed how to make diagrams like this with a combination of base <strong>R</strong> and <a href="https://www.libreoffice.org/discover/draw/">Libre Office Draw</a>.</p>
<p>It’d be nice, however, if one could make plots like this entirely within <strong>R</strong>, preferable with a <strong>tidyverse</strong>-style workflow. With help from the handy new <strong>patchwork</strong> package, I believe we can make it work. In this post, I’ll walk through a few attempts.</p>
<div id="figure-8.2-keep-it-simple." class="section level3">
<h3>Figure 8.2: Keep it simple.</h3>
<p>One way to conceptualize Figure 8.2 is to break it down into discrete parts. To my mind, there are five. Starting from the top and going down, we have</p>
<ul>
<li>a plot of a beta density,</li>
<li>an annotated arrow,</li>
<li>a bar plot of Bernoulli data,</li>
<li>another annotated arrow, and</li>
<li>some text.</li>
</ul>
<p>If we make and save each component separately with <strong>ggplot2</strong>, we can then combine them with <strong>patchwork</strong> syntax. First we’ll laod the necessary packages.</p>
<pre class="r"><code>library(tidyverse)
library(patchwork)
library(ggforce)</code></pre>
<p>We won’t need <strong>ggforce</strong> for this first diagram, but it’ll come in handy below. Before we start making our subplots, we can use <code>theme_set()</code> to adjust the global theme.</p>
<pre class="r"><code>theme_set(theme_grey() +
            theme_void() +
            theme(plot.margin = margin(0, 5.5, 0, 5.5)))</code></pre>
<p>Here we’ll make the 5 subplots, saving them as <code>p1</code>, <code>p2</code>, and so on. Since I’m presuming a working fluency with <strong>ggplot2</strong> and <strong>tidyverse</strong> basics, I’m not going to explain the plot code in detail. If you’re new to plotting like this, execute the code for a given plot line by line to see how each layer builds on the last.</p>
<pre class="r"><code># plot of a beta density
p1 &lt;-
  tibble(x = seq(from = .01, to = .99, by = .01),
         d = (dbeta(x, 2, 2)) / max(dbeta(x, 2, 2))) %&gt;% 
  
  ggplot(aes(x = x, ymin = 0, ymax = d)) +
  geom_ribbon(fill = &quot;skyblue&quot;, size = 0) +
  annotate(geom = &quot;text&quot;,
           x = .5, y = .2,
           label = &quot;beta&quot;,
           size = 7) +
  annotate(geom = &quot;text&quot;,
           x = .5, y = .6,
           label = &quot;italic(A)*&#39;, &#39;*italic(B)&quot;, 
           size = 7, family = &quot;Times&quot;, parse = TRUE) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(axis.line.x = element_line(size = 0.5))

# an annotated arrow
p2 &lt;-
  tibble(x    = .5,
         y    = 1,
         xend = .5,
         yend = 0) %&gt;%
  
  ggplot(aes(x = x, xend = xend,
             y = y, yend = yend)) +
  geom_segment(arrow = arrow(length = unit(0.4, &quot;cm&quot;), type = &quot;closed&quot;)) +
  annotate(geom = &quot;text&quot;,
           x = .375, y = 1/3,
           label = &quot;&#39;~&#39;&quot;,
           size = 10, family = &quot;Times&quot;, parse = T) +
  xlim(0, 1) +
  ylim(0, 1)

# bar plot of Bernoulli data
p3 &lt;-
  tibble(x = 0:1,
         d = (dbinom(x, size = 1, prob = .6)) / max(dbinom(x, size = 1, prob = .6))) %&gt;% 
  
  ggplot(aes(x = x, y = d)) +
  geom_col(fill = &quot;skyblue&quot;, width = .4) +
  annotate(geom = &quot;text&quot;,
           x = .5, y = .2,
           label = &quot;Bernoulli&quot;,
           size = 7) +
  annotate(geom = &quot;text&quot;,
           x = .5, y = .94,
           label = &quot;theta&quot;, 
           size = 7, family = &quot;Times&quot;, parse = T) +
  xlim(-.75, 1.75) +
  theme(axis.line.x = element_line(size = 0.5))

# another annotated arrow
p4 &lt;-
  tibble(x     = c(.375, .625),
         y     = c(1/3, 1/3),
         label = c(&quot;&#39;~&#39;&quot;, &quot;italic(i)&quot;)) %&gt;% 
  
  ggplot(aes(x = x, y = y, label = label)) +
  geom_text(size = c(10, 7), parse = T, family = &quot;Times&quot;) +
  geom_segment(x = .5, xend = .5,
               y = 1, yend = 0,
               arrow = arrow(length = unit(0.4, &quot;cm&quot;), type = &quot;closed&quot;)) +
  xlim(0, 1) +
  ylim(0, 1)

# some text
p5 &lt;-
  tibble(x     = 1,
         y     = .5,
         label = &quot;italic(y[i])&quot;) %&gt;% 
  
  ggplot(aes(x = x, y = y, label = label)) +
  geom_text(size = 7, parse = T, family = &quot;Times&quot;) +
  xlim(0, 2) +
  ylim(0, 1)</code></pre>
<pre class="r"><code>layout &lt;- c(
  area(t = 1, b = 2, l = 1, r = 1),
  area(t = 3, b = 3, l = 1, r = 1),
  area(t = 4, b = 5, l = 1, r = 1),
  area(t = 6, b = 6, l = 1, r = 1),
  area(t = 7, b = 7, l = 1, r = 1)
)

(p1 + p2 + p3 + p4 + p5) + 
  plot_layout(design = layout)</code></pre>
<p><img src="/post/2020-03-09-make-model-diagrams-kruschke-style_files/figure-html/unnamed-chunk-4-1.png" width="192" /></p>
<p>For that plot, the settings in the R Markdown code chunk were <code>fig.width = 1.75, fig.height = 3.5</code>. An obvious difference between our plot and Kruschke’s is whereas he depicted the beta density with a line, I used <code>geom_ribbon()</code> to fill the shape in. If you prefer Kruschke’s approach, just use something like <code>geom_line()</code> instead.</p>
<p>Within some of the <code>annotate()</code> and <code>geom_text()</code> functions, you may have noticed we set <code>parse = T</code>. Though it wasn’t always necessary, it helps streamline the workflow. I found this particularly helpful when setting the coordinates for the tildes (i.e. the <span class="math inline">\(\sim\)</span> signs).</p>
<p>The main thing to focus on is the <strong>patchwork</strong> syntax from that last code block. We combined the five subplots with the <code>(p1 + p2 + p3 + p4 + p5)</code> code. It was the <code>plot_layout(design = layout)</code> part and the associated code defining <code>layout</code> that helped us arrange the subplots in the right order and according to the desired size ratios. For each subplot, we used the <code>t</code>, <code>b</code>, <code>l</code>, and <code>r</code> parameters to define the four bounds (top, bottom, left, and right) in overall plot grid. You can learn more about this works from Thomas Lin Pedersen’s <a href="https://patchwork.data-imaginist.com/articles/guides/layout.html"><em>Controlling Layouts</em></a> and <a href="https://patchwork.data-imaginist.com/reference/area.html"><em>Specify a plotting area in a layout</em></a> vignettes.</p>
<p>Now we’ve covered the basics, it’s time to build.</p>
</div>
<div id="figure-9.1-add-offset-formula-spacing-and-curvy-lines." class="section level3">
<h3>Figure 9.1: Add offset formula spacing and curvy lines.</h3>
<p>For our next challenge, we’ll tackle Kruschke’s Figure 9.1:</p>
<p><img src="/img/Kruschke_figure9.1.png" /></p>
<p>From a statistical perspective, this model is interesting in that it uses a hierarchical prior specification wherein the lower-level beta density is parameterized in terms <span class="math inline">\(\omega\)</span> (mode) and <span class="math inline">\(K\)</span> (concentration). From a plotting perspective, adding more density and arrow subplots isn’t a big deal. But see how the <span class="math inline">\(\omega(K-2)+1, (1-\omega)(K-2)+1\)</span> formula extends way out past the right bound of that second beta density? Also, check those wavy arrows right above. These require an amended workflow. Let’s go step by step. The top subplot is farily simple.</p>
<pre class="r"><code>p1 &lt;-
  tibble(x = seq(from = .01, to = .99, by = .01),
       d = (dbeta(x, 2, 2)) / max(dbeta(x, 2, 2))) %&gt;% 
  ggplot(aes(x = x, ymin = 0, ymax = d)) +
  geom_ribbon(fill = &quot;skyblue&quot;, size = 0) +
  annotate(geom = &quot;text&quot;,
           x = .5, y = .2,
           label = &quot;beta&quot;,
           size = 7) +
  annotate(geom = &quot;text&quot;,
           x = .5, y = .6,
           label = &quot;italic(A[omega])*&#39;, &#39;*italic(B[omega])&quot;, 
           size = 7, family = &quot;Times&quot;, parse = TRUE) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(axis.line.x = element_line(size = 0.5))

p1</code></pre>
<p><img src="/post/2020-03-09-make-model-diagrams-kruschke-style_files/figure-html/unnamed-chunk-5-1.png" width="192" /></p>
<p>Now things get wacky.</p>
<p>We are going to make the formula and the wavy lies in one subplot. We can define the basic coordinates for the wavy lines with the <code>ggforce::geom_bspline()</code> function (learn more <a href="https://ggforce.data-imaginist.com/reference/geom_bspline.html">here</a>). For each line segment, we just need about 5 pairs of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> coordinates. There’s no magic solution to these coordinates. I came to them by trial and error. As far as the formula goes, it isn’t much more complicated from what we’ve been doing. It’s all just a bunch of <a href="https://stat.ethz.ch/R-manual/R-devel/library/grDevices/html/plotmath.html">plotmath syntax</a>. The main deal is to notice how we’ve set the <code>limits</code> in <code>the scale_x_continuous()</code> function to c<code>(0, 2)</code>. In the other plots, those are restricted to <code>0, 1</code>.</p>
<pre class="r"><code>p2 &lt;-
  tibble(x = c(.5, .475, .26, .08, .06,
               .5, .55, .8, 1.1, 1.15),
         y = c(1, .7, .6, .5, .2,
               1, .7, .6, .5, .2),
         line = rep(letters[1:2], each = 5)) %&gt;% 
  
  ggplot(aes(x = x, y = y)) +
  geom_bspline(aes(color = line),
               size = 2/3, show.legend = F) + 
  annotate(geom = &quot;text&quot;,
           x = 0, y = .125,
           label = &quot;omega(italic(K)-2)+1*&#39;, &#39;*(1-omega)(italic(K)-2)+1&quot;,
           size = 7, parse = T, family = &quot;Times&quot;, hjust = 0) +
  annotate(geom = &quot;text&quot;,
           x = 1/3, y = .7,
           label = &quot;&#39;~&#39;&quot;,
           size = 10, parse = T, family = &quot;Times&quot;) +
  scale_color_manual(values = c(&quot;black&quot;, &quot;grey75&quot;)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 2)) +
  ylim(0, 1) +
  theme_void()

p2</code></pre>
<p><img src="/post/2020-03-09-make-model-diagrams-kruschke-style_files/figure-html/unnamed-chunk-6-1.png" width="384" /></p>
<p>You’ll see how this will works when we combine all the subplots, below. The rest of the subplots are similar or identical to the ones from the first section. Here we’ll make them in bulk.</p>
<pre class="r"><code># another beta density
p3 &lt;-
  tibble(x = seq(from = .01, to = .99, by = .01),
         d = (dbeta(x, 2, 2)) / max(dbeta(x, 2, 2))) %&gt;% 
  ggplot(aes(x = x, ymin = 0, ymax = d)) +
  geom_ribbon(fill = &quot;skyblue&quot;, size = 0) +
  annotate(geom = &quot;text&quot;,
           x = .5, y = .2,
           label = &quot;beta&quot;,
           size = 7) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(axis.line.x = element_line(size = 0.5))

# an annotated arrow
p4 &lt;-
  tibble(x    = .5,
         y    = 1,
         xend = .5,
         yend = 0) %&gt;%
  
  ggplot(aes(x = x, xend = xend,
             y = y, yend = yend)) +
  geom_segment(arrow = arrow(length = unit(0.4, &quot;cm&quot;), type = &quot;closed&quot;)) +
  annotate(geom = &quot;text&quot;,
           x = .375, y = 1/3,
           label = &quot;&#39;~&#39;&quot;,
           size = 10, family = &quot;Times&quot;, parse = T) +
  xlim(0, 1) +
  ylim(0, 1)

# bar plot of Bernoulli data
p5 &lt;-
  tibble(x = 0:1,
         d = (dbinom(x, size = 1, prob = .6)) / max(dbinom(x, size = 1, prob = .6))) %&gt;% 
  
  ggplot(aes(x = x, y = d)) +
  geom_col(fill = &quot;skyblue&quot;, width = .4) +
  annotate(geom = &quot;text&quot;,
           x = .5, y = .2,
           label = &quot;Bernoulli&quot;,
           size = 7) +
  annotate(geom = &quot;text&quot;,
           x = .5, y = .94,
           label = &quot;theta&quot;, 
           size = 7, family = &quot;Times&quot;, parse = T) +
  xlim(-.75, 1.75) +
  theme(axis.line.x = element_line(size = 0.5))

# another annotated arrow
p6 &lt;-
  tibble(x     = c(.375, .625),
         y     = c(1/3, 1/3),
         label = c(&quot;&#39;~&#39;&quot;, &quot;italic(i)&quot;)) %&gt;% 
  
  ggplot(aes(x = x, y = y, label = label)) +
  geom_text(size = c(10, 7), parse = T, family = &quot;Times&quot;) +
  geom_segment(x = .5, xend = .5,
               y = 1, yend = 0,
               arrow = arrow(length = unit(0.4, &quot;cm&quot;), type = &quot;closed&quot;)) +
  xlim(0, 1) +
  ylim(0, 1)

# some text
p7 &lt;-
  tibble(x     = .5,
         y     = .5,
         label = &quot;italic(y[i])&quot;) %&gt;% 
  
  ggplot(aes(x = x, y = y, label = label)) +
  geom_text(size = 7, parse = T, family = &quot;Times&quot;) +
  xlim(0, 1) +
  ylim(0, 1)</code></pre>
<p>Now combine the subplots with <strong>patchwork</strong>.</p>
<pre class="r"><code>layout &lt;- c(
  area(t = 1, b = 2, l = 1, r = 1),
  area(t = 4, b = 5, l = 1, r = 1),
  area(t = 3, b = 4, l = 1, r = 2),
  area(t = 6, b = 6, l = 1, r = 1),
  area(t = 7, b = 8, l = 1, r = 1),
  area(t = 9, b = 9, l = 1, r = 1),
  area(t = 10, b = 10, l = 1, r = 1)
)

(p1 + p3 + p2 + p4 + p5 + p6 + p7) + 
  plot_layout(design = layout)</code></pre>
<p><img src="/post/2020-03-09-make-model-diagrams-kruschke-style_files/figure-html/unnamed-chunk-8-1.png" width="384" /></p>
</div>
</div>
